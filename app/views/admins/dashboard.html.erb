<h1>Dashboard</h1>

<!-- Bulk Select Toggle -->
<label>
  <input type="checkbox" id="bulk-toggle"> Enable multi-select
</label>

<!-- Search form -->
<%= form_with url: dashboard_path, method: :get, html: { id: "search-form" } do %>
  <%= text_field_tag :query, params[:query], placeholder: "Search by name", id: "search-input" %>
<% end %>

<!-- Participants list -->
<div class="participants-grid">
  <% @participants.sort.each do |participant| %>
    <div class="participant-card" data-id="<%= participant.id %>" onclick="showModal(<%= participant.id %>)">
      <!-- Hidden checkbox (shown if bulk mode is on) -->
      <input type="checkbox" name="participant_ids[]" value="<%= participant.id %>" style="display:none;" class="bulk-checkbox">
      <p>ID: <%= participant.participant_id %></p>
      <p>Name: <%= participant.name %></p>
      <p>Balance: <%= participant.balance %></p>
    </div>
    <!-- Main detail modal -->
    <div id="modal-<%= participant.id %>" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="hideModal(<%= participant.id %>)">&times;</span>
        <h3>Extra Details for <%= participant.name %></h3>
        <p>Pronouns: <%= participant.pronouns %></p>
        <p>Email: <%= participant.email %></p>
        <!-- Buttons to open secondary modals -->
        <button onclick="showBuyModal(<%= participant.id %>)">Buy</button>
        <button onclick="showSetBalanceModal(<%= participant.id %>)">Set Balance</button>
        <button >Earn</button>
      </div>
    </div>
    <!-- Buy modal -->
    <div id="buyModal-<%= participant.id %>" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="hideBuyModal(<%= participant.id %>)">&times;</span>
        <h4>Buy for <%= participant.name %></h4>
        <form action="#" method="POST">
          <!-- Your product/quantity fields go here -->
          <label>Quantity:</label>
          <input type="number" name="quantity" min="1">
          <button type="submit">Confirm Purchase</button>
        </form>
      </div>
    </div>
    
    <!-- Set Balance modal -->
    <div id="setBalanceModal-<%= participant.id %>" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close" onclick="hideSetBalanceModal(<%= participant.id %>)">&times;</span>
        <h4>Set Balance for <%= participant.name %></h4>
        <form action="<%= set_balance_path(participant.id) %>" method="POST">
          <!-- Rails needs authenticity token -->
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

          <label>New Balance:</label>
          <input type="number" name="balance" min="0">
          <button type="submit">Update Balance</button>
        </form>
      </div>
    </div>
  <% end %>
</div>

<!-- Fixed-position bulk earn region (hidden initially) -->
<div id="bulk-earn-bar" style="display:none; position:fixed; bottom:0; left:0; width:100%; background:#ccc; padding:1rem;">
  <%= form_with url: bulk_earn_path, method: :post, local: true, id: "bulk-earn-form" do %>
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <label>Amount to Earn:</label>
    <input type="number" name="amount" min="1" />
    <button type="submit">Give Earnings</button>
  <% end %>
</div>

<!-- Basic modal styling/JS -->
<style>
  .participants-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }
  .participant-card {
    border: 1px solid #ccc;
    padding: 1rem;
    background-color: #f9f9f9;
    cursor: pointer;
  }
  .modal {
    position: fixed; 
    z-index: 999; 
    left: 0; top: 0;
    width: 100%; height: 100%; 
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fff; 
    margin: 10% auto; 
    padding: 1rem; 
    width: 50%;
  }
  .close {
    float: right; 
    font-size: 1.2rem;
    cursor: pointer;
  }
</style>

<script>
  function showModal(id) {
    document.getElementById('modal-' + id).style.display = 'block';
  }
  function hideModal(id) {
    document.getElementById('modal-' + id).style.display = 'none';
  }
  function showBuyModal(id) {
    document.getElementById('buyModal-' + id).style.display = 'block';
  }
  function hideBuyModal(id) {
    document.getElementById('buyModal-' + id).style.display = 'none';
  }
  function showSetBalanceModal(id) {
    document.getElementById('setBalanceModal-' + id).style.display = 'block';
  }
  function hideSetBalanceModal(id) {
    document.getElementById('setBalanceModal-' + id).style.display = 'none';
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var input = document.getElementById("search-input");
    var cards = document.querySelectorAll(".participant-card");
    input.addEventListener("input", function() {
      var query = input.value.toLowerCase();
      cards.forEach(function(card) {
        var name = card.querySelector("p:nth-child(2)").textContent.toLowerCase();
        card.style.display = name.includes(query) ? "" : "none";
      });
    });
  });
</script>
<script>
  // Toggle bulk checkbox visibility
  document.getElementById('bulk-toggle').addEventListener('change', function(e) {
    const checked = e.target.checked;
    // Show/Hide checkboxes
    document.querySelectorAll('.bulk-checkbox').forEach(cb => {
      cb.style.display = checked ? '' : 'none';
    });
    // Show/Hide the bottom bar
    document.getElementById('bulk-earn-bar').style.display = checked ? '' : 'none';

    // If turning off bulk select, uncheck all boxes
    if (!checked) {
      document.querySelectorAll('.bulk-checkbox').forEach(cb => {
        cb.checked = false;
      });
    }
  });

  // Prevent opening modals when in bulk mode (only want checkboxes to be clickable)
  document.querySelectorAll('.participant-card').forEach(card => {
    card.addEventListener('click', function(e) {
      // If weâ€™re in bulk mode, just toggle the checkbox, do not open the modal
      if (document.getElementById('bulk-toggle').checked) {
        e.stopPropagation();  // Stop showModal
        const checkbox = card.querySelector('.bulk-checkbox');
        checkbox.checked = !checkbox.checked;
      }
    });
  });

  // Add any existing JS for modals, searching, etc.
</script>
